---
title: "Laporan Uji Proporsi dan Varians - NusaStat Dashboard"
subtitle: "`r params$jenis_uji`"
author: "NusaStat Dashboard"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  word_document:
    reference_docx: NULL
  pdf_document:
    latex_engine: xelatex
    keep_tex: false
params:
  jenis_uji: "Uji Proporsi"
  hasil_uji: NULL
  interpretasi: NULL
  input_params: NULL
  plot_path: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(flextable)
library(dplyr)
```

# Laporan Uji Proporsi dan Varians

## Informasi Analisis

**Jenis Uji:** `r params$jenis_uji`

**Tanggal Analisis:** `r format(Sys.Date(), '%d %B %Y')`

**Tingkat Signifikansi (α):** `r if(!is.null(params$input_params)) params$input_params$alpha else "0.05"`

---

## Parameter Uji

```{r test-params}
if (!is.null(params$input_params)) {
    if (params$input_params$test_choice == "proportion") {
        param_df <- data.frame(
            Parameter = c("Jenis Uji", "Jumlah Sukses (x)", "Jumlah Percobaan (n)", "Proporsi Hipotesis (p₀)", "Hipotesis Alternatif"),
            Nilai = c(
                "Uji Proporsi Satu Sampel",
                params$input_params$x_prop %||% "0",
                params$input_params$n_prop %||% "0",
                params$input_params$p_test %||% "0.5",
                params$input_params$alternative %||% "two.sided"
            )
        )
    } else {
        param_df <- data.frame(
            Parameter = c("Jenis Uji", "Variabel", "Varians Hipotesis (σ₀²)", "Hipotesis Alternatif"),
            Nilai = c(
                "Uji Varians Satu Sampel",
                params$input_params$var_variance %||% "Variabel",
                params$input_params$var_test %||% "1",
                params$input_params$alternative %||% "two.sided"
            )
        )
    }

    ft <- flextable(param_df) %>%
        set_header_labels(
            Parameter = "Parameter Uji",
            Nilai = "Nilai"
        ) %>%
        theme_vanilla() %>%
        autofit() %>%
        align(align = "center", part = "header")

    ft
}
```

---

## Hipotesis

```{r hypothesis}
if (!is.null(params$input_params)) {
    if (params$input_params$test_choice == "proportion") {
        p0 <- params$input_params$p_test %||% "0.5"
        cat("**H₀ (Hipotesis Nol):** p = ", p0, "\n\n")

        alt_text <- switch(params$input_params$alternative %||% "two.sided",
            "two.sided" = paste("p ≠", p0),
            "greater" = paste("p >", p0),
            "less" = paste("p <", p0)
        )
        cat("**H₁ (Hipotesis Alternatif):** ", alt_text, "\n\n")

        cat("**Keterangan:**\n")
        cat("- p: proporsi populasi yang sebenarnya\n")
        cat("- p₀: proporsi yang dihipotesiskan\n")
    } else {
        var0 <- params$input_params$var_test %||% "1"
        cat("**H₀ (Hipotesis Nol):** σ² = ", var0, "\n\n")

        alt_text <- switch(params$input_params$alternative %||% "two.sided",
            "two.sided" = paste("σ² ≠", var0),
            "greater" = paste("σ² >", var0),
            "less" = paste("σ² <", var0)
        )
        cat("**H₁ (Hipotesis Alternatif):** ", alt_text, "\n\n")

        cat("**Keterangan:**\n")
        cat("- σ²: varians populasi yang sebenarnya\n")
        cat("- σ₀²: varians yang dihipotesiskan\n")
    }
}
```

---

## Hasil Uji Statistik

```{r test-results}
if (!is.null(params$hasil_uji)) {
    if (!is.null(params$input_params) && params$input_params$test_choice == "proportion") {
        # Proportion test results
        hasil_df <- data.frame(
            Statistik = c("z-statistic", "p-value", "Confidence Interval (95%)", "Sample Proportion"),
            Nilai = c(
                round(params$hasil_uji$statistic, 4),
                format(params$hasil_uji$p.value, scientific = TRUE, digits = 4),
                paste(round(params$hasil_uji$conf.int[1], 4), "-", round(params$hasil_uji$conf.int[2], 4)),
                round(params$hasil_uji$estimate, 4)
            )
        )
    } else {
        # Variance test results
        hasil_df <- data.frame(
            Statistik = c("χ²-statistic", "Derajat Kebebasan", "p-value", "Sample Variance"),
            Nilai = c(
                round(params$hasil_uji$statistic, 4),
                round(params$hasil_uji$parameter, 0),
                format(params$hasil_uji$p.value, scientific = TRUE, digits = 4),
                round(params$hasil_uji$sample.var, 4)
            )
        )
    }

    ft <- flextable(hasil_df) %>%
        set_header_labels(
            Statistik = "Statistik Uji",
            Nilai = "Nilai"
        ) %>%
        theme_vanilla() %>%
        autofit() %>%
        align(align = "center", part = "header")

    ft
} else {
    cat("Hasil uji tidak tersedia.")
}
```

---

## Statistik Deskriptif

```{r descriptive-stats}
if (!is.null(params$input_params) && !is.null(params$hasil_uji)) {
    if (params$input_params$test_choice == "proportion") {
        x <- params$input_params$x_prop %||% 0
        n <- params$input_params$n_prop %||% 1
        p_sample <- x / n

        desc_df <- data.frame(
            Statistik = c("Jumlah Sukses", "Jumlah Percobaan", "Proporsi Sampel", "Proporsi Hipotesis"),
            Nilai = c(x, n, round(p_sample, 4), params$input_params$p_test %||% 0.5)
        )
    } else {
        desc_df <- data.frame(
            Statistik = c("Varians Sampel", "Varians Hipotesis", "Ukuran Sampel"),
            Nilai = c(
                round(params$hasil_uji$sample.var, 4),
                params$input_params$var_test %||% 1,
                params$hasil_uji$parameter + 1
            )
        )
    }

    ft <- flextable(desc_df) %>%
        set_header_labels(
            Statistik = "Statistik Deskriptif",
            Nilai = "Nilai"
        ) %>%
        theme_vanilla() %>%
        autofit() %>%
        align(align = "center", part = "header")

    ft
}
```

---

## Visualisasi

```{r plot-display, fig.cap="Visualisasi Data", out.width="100%"}
if (!is.null(params$plot_path) && file.exists(params$plot_path)) {
    knitr::include_graphics(params$plot_path)
} else {
    cat("Plot tidak tersedia.")
}
```

---

## Interpretasi dan Kesimpulan

```{r interpretation}
if (!is.null(params$interpretasi)) {
    cat(params$interpretasi)
} else if (!is.null(params$hasil_uji)) {
    alpha <- params$input_params$alpha %||% 0.05
    p_val <- params$hasil_uji$p.value

    cat("### Keputusan Statistik\n\n")

    if (p_val < alpha) {
        cat("**Keputusan:** Tolak H₀\n\n")
        cat(
            "**Kesimpulan:** Pada tingkat signifikansi α =", alpha,
            ", terdapat bukti yang cukup untuk menolak hipotesis nol."
        )
    } else {
        cat("**Keputusan:** Gagal menolak H₀\n\n")
        cat(
            "**Kesimpulan:** Pada tingkat signifikansi α =", alpha,
            ", tidak terdapat bukti yang cukup untuk menolak hipotesis nol."
        )
    }

    cat("\n\n**p-value =", format(p_val, scientific = TRUE, digits = 4), "**")

    if (!is.null(params$input_params)) {
        if (params$input_params$test_choice == "proportion") {
            cat("\n\n**Interpretasi Praktis:**\n")
            if (p_val < alpha) {
                cat("Proporsi sampel berbeda secara signifikan dari proporsi yang dihipotesiskan.")
            } else {
                cat("Proporsi sampel tidak berbeda secara signifikan dari proporsi yang dihipotesiskan.")
            }
        } else {
            cat("\n\n**Interpretasi Praktis:**\n")
            if (p_val < alpha) {
                cat("Varians sampel berbeda secara signifikan dari varians yang dihipotesiskan.")
            } else {
                cat("Varians sampel tidak berbeda secara signifikan dari varians yang dihipotesiskan.")
            }
        }
    }
}
```

### Asumsi Uji

```{r assumptions}
if (!is.null(params$input_params)) {
    if (params$input_params$test_choice == "proportion") {
        cat("**Asumsi Uji Proporsi:**\n\n")
        cat("1. **Independensi:** Setiap percobaan harus independen\n")
        cat("2. **Binomial:** Data mengikuti distribusi binomial\n")
        cat("3. **Ukuran Sampel:** np₀ ≥ 5 dan n(1-p₀) ≥ 5 untuk aproksimasi normal\n")

        n <- params$input_params$n_prop %||% 0
        p0 <- params$input_params$p_test %||% 0.5
        np0 <- n * p0
        n1_p0 <- n * (1 - p0)

        cat("\n**Validasi Asumsi:**\n")
        cat("- np₀ =", round(np0, 2), if (np0 >= 5) "✓" else "✗", "\n")
        cat("- n(1-p₀) =", round(n1_p0, 2), if (n1_p0 >= 5) "✓" else "✗", "\n")
    } else {
        cat("**Asumsi Uji Varians:**\n\n")
        cat("1. **Normalitas:** Data harus berdistribusi normal\n")
        cat("2. **Independensi:** Observasi harus independen\n")
        cat("3. **Satu Sampel:** Uji ini untuk satu sampel vs nilai hipotesis\n")
    }
}
```

### Interval Kepercayaan

```{r confidence-interval}
if (!is.null(params$hasil_uji) && !is.null(params$hasil_uji$conf.int)) {
    ci_lower <- round(params$hasil_uji$conf.int[1], 4)
    ci_upper <- round(params$hasil_uji$conf.int[2], 4)

    cat("**Interval Kepercayaan 95%:** [", ci_lower, ", ", ci_upper, "]\n\n")

    if (!is.null(params$input_params)) {
        if (params$input_params$test_choice == "proportion") {
            cat(
                "**Interpretasi:** Dengan tingkat kepercayaan 95%, proporsi populasi yang sebenarnya berada antara",
                ci_lower, "dan", ci_upper, ".\n"
            )
        } else {
            cat(
                "**Interpretasi:** Dengan tingkat kepercayaan 95%, varians populasi yang sebenarnya berada antara",
                ci_lower, "dan", ci_upper, ".\n"
            )
        }
    }
}
```

### Rekomendasi

```{r recommendations}
if (!is.null(params$hasil_uji)) {
    p_val <- params$hasil_uji$p.value
    alpha <- params$input_params$alpha %||% 0.05

    cat("**Rekomendasi Berdasarkan Hasil:**\n\n")

    if (p_val < alpha) {
        cat("- Hasil menunjukkan perbedaan yang signifikan secara statistik\n")
        cat("- Pertimbangkan kepentingan praktis dari perbedaan yang ditemukan\n")
        cat("- Lakukan replikasi studi untuk konfirmasi\n")
        if (!is.null(params$input_params) && params$input_params$test_choice == "proportion") {
            cat("- Evaluasi faktor-faktor yang mungkin mempengaruhi proporsi\n")
        } else {
            cat("- Investigasi sumber variabilitas yang menyebabkan perbedaan varians\n")
        }
    } else {
        cat("- Tidak terdapat bukti yang cukup untuk menolak hipotesis nol\n")
        cat("- Pertimbangkan untuk memperbesar ukuran sampel jika diperlukan\n")
        cat("- Evaluasi kembali hipotesis atau desain penelitian\n")
        cat("- Pastikan asumsi uji terpenuhi\n")
    }
}
```

---

## Metode Statistik

### Uji Proporsi

Menggunakan **z-test untuk proporsi satu sampel** dengan rumus:

$$z = \frac{\hat{p} - p_0}{\sqrt{\frac{p_0(1-p_0)}{n}}}$$

Dimana:
- $\hat{p}$: proporsi sampel
- $p_0$: proporsi yang dihipotesiskan  
- $n$: ukuran sampel

### Uji Varians

Menggunakan **Chi-square test untuk varians** dengan rumus:

$$\chi^2 = \frac{(n-1)s^2}{\sigma_0^2}$$

Dimana:
- $s^2$: varians sampel
- $\sigma_0^2$: varians yang dihipotesiskan
- $n-1$: derajat kebebasan

---

*Laporan ini dihasilkan secara otomatis oleh NusaStat Dashboard pada `r format(Sys.time(), '%d %B %Y pukul %H:%M WIB')`*
